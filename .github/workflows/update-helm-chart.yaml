name: Update Helm Chart

on:
  release:
    types: [published]
  repository_dispatch:
    types: [helm-chart-update]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update (without v prefix)'
        required: true
        type: string

jobs:
  update-chart:
    name: Update Helm Chart Version
    runs-on: ubuntu-latest
    steps:
      - name: Check required secrets
        run: |
          if [ -z "${{ secrets.CHARTS_REPO_TOKEN }}" ]; then
            echo "::error::CHARTS_REPO_TOKEN secret is not set"
            exit 1
          fi

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          elif [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            VERSION="${{ github.event.client_payload.version }}"
            VERSION="${VERSION#v}"
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Checkout operator repository
        uses: actions/checkout@v4
        with:
          path: operator

      - name: Checkout charts repository
        uses: actions/checkout@v4
        with:
          repository: fredericrous/charts
          token: ${{ secrets.CHARTS_REPO_TOKEN }}
          path: charts

      - name: Sync CRDs from operator
        run: |
          CHART_NAME="${{ github.event.repository.name }}"
          CHART_DIR="charts/charts/${CHART_NAME}"

          if [ ! -d "${CHART_DIR}" ]; then
            echo "::error::Chart directory does not exist at ${CHART_DIR}"
            exit 1
          fi

          echo "Syncing CRDs..."
          mkdir -p "${CHART_DIR}/crds"
          cp -v operator/config/crd/bases/*.yaml "${CHART_DIR}/crds/"

      - name: Update Chart.yaml
        id: update-chart
        run: |
          cd charts
          CHART_NAME="${{ github.event.repository.name }}"
          CHART_PATH="charts/${CHART_NAME}/Chart.yaml"
          NEW_VERSION="${{ steps.version.outputs.version }}"

          echo "Updating chart to version $NEW_VERSION"
          yq -i ".version = \"$NEW_VERSION\"" "$CHART_PATH"
          yq -i ".appVersion = \"$NEW_VERSION\"" "$CHART_PATH"

          echo "chart_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          cat "$CHART_PATH"

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.CHARTS_REPO_TOKEN }}
          path: charts
          add-paths: |
            charts/${{ github.event.repository.name }}/**
          commit-message: "chore: update ${{ github.event.repository.name }} to ${{ steps.version.outputs.version }}"
          title: "chore: update ${{ github.event.repository.name }} to ${{ steps.version.outputs.version }}"
          body: |
            ## Automated Chart Update

            Updates **${{ github.event.repository.name }}** chart to version `${{ steps.update-chart.outputs.chart_version }}`

            ### Changes
            - Chart and app version updated to `${{ steps.update-chart.outputs.chart_version }}`
            - CRDs synced from operator

            ---
            *Triggered by [operator release v${{ steps.version.outputs.version }}](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }})*
          branch: update-${{ github.event.repository.name }}-${{ steps.version.outputs.version }}
          base: main
          labels: |
            chart-update
            automated

      - name: Enable auto-merge
        if: steps.create-pr.outputs.pull-request-number && github.event_name == 'release'
        continue-on-error: true
        run: |
          gh pr merge ${{ steps.create-pr.outputs.pull-request-number }} \
            --repo fredericrous/charts \
            --auto \
            --squash
        env:
          GH_TOKEN: ${{ secrets.CHARTS_REPO_TOKEN }}
