name: Update Helm Chart

on:
  release:
    types: [published]
  repository_dispatch:
    types: [helm-chart-update]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update (without v prefix)'
        required: true
        type: string
      bump_chart_version:
        description: 'Bump chart version'
        required: false
        type: boolean
        default: true
      version_bump_type:
        description: 'Version bump type (auto, major, minor, patch)'
        required: false
        type: string
        default: 'auto'

jobs:
  update-chart:
    name: Update Helm Chart Version
    runs-on: ubuntu-latest
    steps:
      - name: Check required secrets
        run: |
          if [ -z "${{ secrets.CHARTS_REPO_TOKEN }}" ]; then
            echo "::error::CHARTS_REPO_TOKEN secret is not set. This secret is required to create PRs on the charts repository."
            echo "::error::Please add a Personal Access Token with 'repo' scope as CHARTS_REPO_TOKEN in repository secrets."
            exit 1
          fi

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          elif [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            VERSION="${{ github.event.client_payload.version }}"
            VERSION="${VERSION#v}"
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Checkout operator repository
        uses: actions/checkout@v4
        with:
          path: operator

      - name: Checkout charts repository
        uses: actions/checkout@v4
        with:
          repository: fredericrous/charts
          token: ${{ secrets.CHARTS_REPO_TOKEN }}
          path: charts

      - name: Sync CRDs and RBAC from operator
        run: |
          CHART_NAME="${{ github.event.repository.name }}"
          CHART_DIR="charts/charts/${CHART_NAME}"

          echo "Syncing all CRDs from operator to chart..."
          cp -v operator/config/crd/bases/*.yaml "${CHART_DIR}/crds/"

          echo "Generating ClusterRole template from operator RBAC..."
          cat > "${CHART_DIR}/templates/clusterrole.yaml" << EOF
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            name: {{ include "${CHART_NAME}.fullname" . }}
            labels:
              {{- include "${CHART_NAME}.labels" . | nindent 4 }}
          EOF
          echo "rules:" >> "${CHART_DIR}/templates/clusterrole.yaml"
          yq '.rules' operator/config/rbac/role.yaml | sed 's/^/  /' >> "${CHART_DIR}/templates/clusterrole.yaml"

          cd charts
          git diff --stat || true
          git status

      - name: Update Chart.yaml
        id: update-chart
        run: |
          cd charts
          CHART_NAME="${{ github.event.repository.name }}"
          CHART_PATH="charts/${CHART_NAME}/Chart.yaml"

          CURRENT_CHART_VERSION=$(yq '.version' "$CHART_PATH")
          CURRENT_APP_VERSION=$(yq '.appVersion' "$CHART_PATH")
          NEW_VERSION="${{ steps.version.outputs.version }}"

          echo "Current state:"
          echo "- Chart version: $CURRENT_CHART_VERSION"
          echo "- App version: $CURRENT_APP_VERSION"
          echo "New version: $NEW_VERSION (chart and app will be synced)"

          # Keep chart version = app version
          yq -i ".version = \"$NEW_VERSION\"" "$CHART_PATH"
          yq -i ".appVersion = \"$NEW_VERSION\"" "$CHART_PATH"

          echo "chart_version=$NEW_VERSION" >> $GITHUB_OUTPUT

          echo "Updated Chart.yaml:"
          cat "$CHART_PATH"

      - name: Update README.md Chart Table
        run: |
          cd charts
          README_FILE="README.md"
          CHART_NAME="${{ github.event.repository.name }}"
          CHART_VERSION="${{ steps.update-chart.outputs.chart_version }}"
          APP_VERSION="${{ steps.version.outputs.version }}"

          if [ -f "$README_FILE" ]; then
            if grep -q "\[${CHART_NAME}\]" "$README_FILE"; then
              echo "Updating existing chart entry in README.md"
              while IFS= read -r line; do
                if [[ "$line" == *"[${CHART_NAME}]"* ]]; then
                  echo "| [${CHART_NAME}](charts/${CHART_NAME}/) | ${CHART_VERSION} | ${APP_VERSION} | A Kubernetes operator that manages DDNS records for ddns-updater |"
                else
                  echo "$line"
                fi
              done < "$README_FILE" > "$README_FILE.tmp" && mv "$README_FILE.tmp" "$README_FILE"
            else
              echo "Chart not found in README.md - manual intervention may be required"
            fi
          fi

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.CHARTS_REPO_TOKEN }}
          path: charts
          add-paths: |
            charts/${{ github.event.repository.name }}/**
            README.md
          commit-message: "chore: update ${{ github.event.repository.name }} to ${{ steps.version.outputs.version }}"
          title: "chore: update ${{ github.event.repository.name }} to ${{ steps.version.outputs.version }}"
          body: |
            ## Automated Chart Update

            This PR updates the ${{ github.event.repository.name }} Helm chart:
            - **Version**: `${{ steps.update-chart.outputs.chart_version }}` (chart and app synced)

            ### Files Updated
            - `charts/${{ github.event.repository.name }}/Chart.yaml` - Updated appVersion and chart version
            - `charts/${{ github.event.repository.name }}/crds/*.yaml` - Synced all CRDs from operator
            - `charts/${{ github.event.repository.name }}/templates/clusterrole.yaml` - Synced RBAC rules from operator
            - `README.md` - Updated chart version and app version in charts table

            ### What's Changed

            ${{ github.event.release.body }}

            ### Next Steps

            After merging this PR, create a new release tag:
            ```bash
            git tag ${{ github.event.repository.name }}-v${{ steps.update-chart.outputs.chart_version }}
            git push origin ${{ github.event.repository.name }}-v${{ steps.update-chart.outputs.chart_version }}
            ```

            ---
            *This PR was automatically generated when [operator version ${{ steps.version.outputs.version }}](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}) was released.*
          branch: update-${{ github.event.repository.name }}-${{ steps.version.outputs.version }}
          base: main
          labels: |
            chart-update
            automated
            operator-release

      - name: Add PR comment with testing instructions
        if: steps.create-pr.outputs.pull-request-number
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.CHARTS_REPO_TOKEN }}
          repository: fredericrous/charts
          issue-number: ${{ steps.create-pr.outputs.pull-request-number }}
          body: |
            ### Testing Instructions

            Test the updated chart locally:
            ```bash
            git clone https://github.com/fredericrous/charts.git
            cd charts
            git checkout update-${{ github.event.repository.name }}-${{ steps.version.outputs.version }}

            helm template ${{ github.event.repository.name }} ./charts/${{ github.event.repository.name }}
            helm lint ./charts/${{ github.event.repository.name }}
            helm install test-release ./charts/${{ github.event.repository.name }} --dry-run --debug
            ```

      - name: Enable auto-merge
        if: steps.create-pr.outputs.pull-request-number && github.event_name == 'release'
        continue-on-error: true
        run: |
          sleep 5
          gh pr merge ${{ steps.create-pr.outputs.pull-request-number }} \
            --repo fredericrous/charts \
            --auto \
            --squash
        env:
          GH_TOKEN: ${{ secrets.CHARTS_REPO_TOKEN }}
